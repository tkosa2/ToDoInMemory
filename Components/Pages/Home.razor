@page "/"
@inject TodoService TodoService
@inject LocalStorageService LocalStorageService
@rendermode InteractiveServer

<PageTitle>ToDo App</PageTitle>

<div class="todo-app">
    <header class="hero">
        <div class="hero-content">
            <h1>My Tasks</h1>
            <p class="subtitle">Stay organized, get things done</p>
        </div>
        <div class="stats">
            <div class="stat-card">
                <span class="stat-number">@TodoService.GetPendingCount()</span>
                <span class="stat-label">Pending</span>
            </div>
            <div class="stat-card completed">
                <span class="stat-number">@TodoService.GetCompletedCount()</span>
                <span class="stat-label">Completed</span>
            </div>
        </div>
    </header>

    <main class="todo-main">
        <div class="add-todo-section">
            <form @onsubmit="AddTodo" class="add-form">
                <div class="add-form-inputs">
                    <input type="text" 
                           @bind="newTodoTitle" 
                           @bind:event="oninput"
                           placeholder="What needs to be done?" 
                           class="todo-input"
                           disabled="@(!isLoaded)" />
                    <select @bind="newTodoPriority" class="priority-select" disabled="@(!isLoaded)">
                        <option value="@Priority.Low">Low</option>
                        <option value="@Priority.Medium">Medium</option>
                        <option value="@Priority.High">High</option>
                    </select>
                </div>
                <button type="submit" class="add-btn" disabled="@(string.IsNullOrWhiteSpace(newTodoTitle) || !isLoaded)">
                    <span class="btn-icon">+</span>
                    <span class="btn-text">Add Task</span>
                </button>
            </form>
        </div>

        <div class="filter-tabs">
            <div class="filter-group">
                <span class="filter-label">Status:</span>
                <button class="filter-btn @(currentFilter == Filter.All ? "active" : "")" @onclick="() => SetFilter(Filter.All)" disabled="@(!isLoaded)">
                    All
                </button>
                <button class="filter-btn @(currentFilter == Filter.Pending ? "active" : "")" @onclick="() => SetFilter(Filter.Pending)" disabled="@(!isLoaded)">
                    Pending
                </button>
                <button class="filter-btn @(currentFilter == Filter.Completed ? "active" : "")" @onclick="() => SetFilter(Filter.Completed)" disabled="@(!isLoaded)">
                    Completed
                </button>
            </div>
            <div class="filter-group">
                <span class="filter-label">Priority:</span>
                <button class="filter-btn @(currentPriorityFilter == PriorityFilter.All ? "active" : "")" @onclick="() => SetPriorityFilter(PriorityFilter.All)" disabled="@(!isLoaded)">
                    All
                </button>
                <button class="filter-btn priority-high @(currentPriorityFilter == PriorityFilter.High ? "active" : "")" @onclick="() => SetPriorityFilter(PriorityFilter.High)" disabled="@(!isLoaded)">
                    High
                </button>
                <button class="filter-btn priority-medium @(currentPriorityFilter == PriorityFilter.Medium ? "active" : "")" @onclick="() => SetPriorityFilter(PriorityFilter.Medium)" disabled="@(!isLoaded)">
                    Medium
                </button>
                <button class="filter-btn priority-low @(currentPriorityFilter == PriorityFilter.Low ? "active" : "")" @onclick="() => SetPriorityFilter(PriorityFilter.Low)" disabled="@(!isLoaded)">
                    Low
                </button>
            </div>
            <div class="filter-group">
                <span class="filter-label">Sort:</span>
                <button class="filter-btn @(currentSort == SortBy.CreatedDate ? "active" : "")" @onclick="() => SetSort(SortBy.CreatedDate)" disabled="@(!isLoaded)">
                    Date
                </button>
                <button class="filter-btn @(currentSort == SortBy.Priority ? "active" : "")" @onclick="() => SetSort(SortBy.Priority)" disabled="@(!isLoaded)">
                    Priority
                </button>
            </div>
        </div>

        <div class="todo-list">
            @if (!FilteredTodos.Any())
            {
                <div class="empty-state">
                    <div class="empty-icon">üìù</div>
                    <p>@GetEmptyMessage()</p>
                </div>
            }
            else
            {
                @foreach (var todo in FilteredTodos)
                {
                    <div class="todo-item @(todo.IsCompleted ? "completed" : "") @(editingId == todo.Id ? "editing" : "") priority-@(todo.Priority.ToString().ToLower())">
                        <button class="check-btn @(todo.IsCompleted ? "checked" : "")" 
                                @onclick="() => ToggleTodo(todo.Id)">
                            @if (todo.IsCompleted)
                            {
                                <span class="checkmark">‚úì</span>
                            }
                        </button>
                        
                        <div class="priority-indicator priority-@(todo.Priority.ToString().ToLower())" title="@todo.Priority Priority">
                        </div>
                        
                        @if (editingId == todo.Id)
                        {
                            <div class="edit-content">
                                <input type="text" 
                                       @bind="editingTitle" 
                                       @bind:event="oninput"
                                       @onkeydown="HandleEditKeyDown"
                                       class="edit-input" />
                                <select @bind="editingPriority" class="priority-select-edit">
                                    <option value="@Priority.Low">Low</option>
                                    <option value="@Priority.Medium">Medium</option>
                                    <option value="@Priority.High">High</option>
                                </select>
                            </div>
                            <div class="edit-actions">
                                <button class="save-btn" @onclick="SaveEdit">Save</button>
                                <button class="cancel-btn" @onclick="CancelEdit">Cancel</button>
                            </div>
                        }
                        else
                        {
                            <div class="todo-content" @ondblclick="() => StartEdit(todo)">
                                <div class="todo-header">
                                    <span class="todo-title">@todo.Title</span>
                                    <span class="priority-badge priority-@(todo.Priority.ToString().ToLower())">@todo.Priority</span>
                                </div>
                                <span class="todo-date">@todo.CreatedAt.ToString("MMM dd, HH:mm")</span>
                            </div>
                            <div class="todo-actions">
                                <button class="edit-btn" @onclick="() => StartEdit(todo)" title="Edit">‚úèÔ∏è</button>
                                <button class="delete-btn" @onclick="() => DeleteTodo(todo.Id)" title="Delete">üóëÔ∏è</button>
                            </div>
                        }
                    </div>
                }
            }
        </div>
    </main>
</div>

@code {
    private string newTodoTitle = string.Empty;
    private Priority newTodoPriority = Priority.Medium;
    private Guid? editingId = null;
    private string editingTitle = string.Empty;
    private Priority editingPriority = Priority.Medium;
    private Filter currentFilter = Filter.All;
    private PriorityFilter currentPriorityFilter = PriorityFilter.All;
    private SortBy currentSort = SortBy.CreatedDate;
    private bool isLoaded = false;

    private enum Filter { All, Pending, Completed }
    private enum PriorityFilter { All, High, Medium, Low }
    private enum SortBy { CreatedDate, Priority }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await TodoService.InitializeAsync();
            isLoaded = true;
            StateHasChanged();
        }
    }

    private IEnumerable<TodoItem> FilteredTodos
    {
        get
        {
            var todos = TodoService.GetAll().AsEnumerable();
            
            // Apply status filter
            todos = currentFilter switch
            {
                Filter.Pending => todos.Where(t => !t.IsCompleted),
                Filter.Completed => todos.Where(t => t.IsCompleted),
                _ => todos
            };
            
            // Apply priority filter
            todos = currentPriorityFilter switch
            {
                PriorityFilter.High => todos.Where(t => t.Priority == Priority.High),
                PriorityFilter.Medium => todos.Where(t => t.Priority == Priority.Medium),
                PriorityFilter.Low => todos.Where(t => t.Priority == Priority.Low),
                _ => todos
            };
            
            // Apply sorting
            return currentSort switch
            {
                SortBy.Priority => todos.OrderByDescending(t => t.Priority).ThenByDescending(t => t.CreatedAt),
                _ => todos
            };
        }
    }

    private async Task AddTodo()
    {
        if (!string.IsNullOrWhiteSpace(newTodoTitle))
        {
            await TodoService.AddAsync(newTodoTitle.Trim(), newTodoPriority);
            newTodoTitle = string.Empty;
            newTodoPriority = Priority.Medium;
        }
    }

    private async Task ToggleTodo(Guid id)
    {
        await TodoService.ToggleCompleteAsync(id);
    }

    private async Task DeleteTodo(Guid id)
    {
        await TodoService.DeleteAsync(id);
    }

    private void StartEdit(TodoItem todo)
    {
        editingId = todo.Id;
        editingTitle = todo.Title;
        editingPriority = todo.Priority;
    }

    private async Task SaveEdit()
    {
        if (editingId.HasValue && !string.IsNullOrWhiteSpace(editingTitle))
        {
            await TodoService.UpdateAsync(editingId.Value, editingTitle.Trim());
            await TodoService.UpdatePriorityAsync(editingId.Value, editingPriority);
        }
        CancelEdit();
    }

    private void CancelEdit()
    {
        editingId = null;
        editingTitle = string.Empty;
        editingPriority = Priority.Medium;
    }

    private async Task HandleEditKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SaveEdit();
        }
        else if (e.Key == "Escape")
        {
            CancelEdit();
        }
    }

    private void SetFilter(Filter filter)
    {
        currentFilter = filter;
    }

    private void SetPriorityFilter(PriorityFilter filter)
    {
        currentPriorityFilter = filter;
    }

    private void SetSort(SortBy sort)
    {
        currentSort = sort;
    }

    private string GetEmptyMessage()
    {
        if (currentPriorityFilter != PriorityFilter.All)
        {
            var priorityName = currentPriorityFilter.ToString();
            return currentFilter switch
            {
                Filter.Pending => $"No pending {priorityName.ToLower()} priority tasks.",
                Filter.Completed => $"No completed {priorityName.ToLower()} priority tasks.",
                _ => $"No {priorityName.ToLower()} priority tasks."
            };
        }
        
        return currentFilter switch
        {
            Filter.Pending => "No pending tasks. Great job!",
            Filter.Completed => "No completed tasks yet.",
            _ => "No tasks yet. Add one above!"
        };
    }
}

